{% extends "base.html" %}

{% block title %}Realizar Quiz - {{ quiz.titulo }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">üìù {{ quiz.titulo }}</h3>
        </div>
        <div class="card-body">
            {% if quiz.tiempo_limite %}
                <div class="alert alert-warning">
                    ‚è∞ <strong>Tiempo l√≠mite:</strong> {{ quiz.tiempo_limite }} minutos
                </div>
            {% endif %}

            <form method="POST" id="quizForm">
                {% csrf_token %}
                
                {% for pregunta in preguntas %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                Pregunta {{ forloop.counter }} 
                                <span class="badge bg-info">{{ pregunta.puntos }} punto(s)</span>
                            </h5>
                            <p class="lead">{{ pregunta.texto }}</p>

                            <div class="mt-3">
                                {% for opcion in pregunta.opciones.all %}
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" 
                                               type="radio" 
                                               name="pregunta_{{ pregunta.id }}" 
                                               id="opcion_{{ opcion.id }}"
                                               value="{{ opcion.id }}"
                                               required>
                                        <label class="form-check-label" for="opcion_{{ opcion.id }}">
                                            {{ opcion.texto }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-success btn-lg" onclick="return confirm('¬øEst√°s seguro de enviar tus respuestas? No podr√°s cambiarlas despu√©s.')">
                        ‚úÖ Enviar respuestas
                    </button>
                    <a href="{% url 'detalle_quiz' quiz.id %}" class="btn btn-secondary">
                        ‚ùå Cancelar (perder√°s el intento)
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

{% if quiz.tiempo_limite %}
<div id="temporizador" class="alert alert-info position-fixed top-0 end-0 m-3" style="z-index: 1000;">
    ‚è∞ Tiempo restante: <span id="tiempo">{{ quiz.tiempo_limite }}:00</span>
</div>

<script>
    // Temporizador de cuenta regresiva
    const tiempoLimiteMinutos = parseInt('{{ quiz.tiempo_limite }}');
    let tiempoRestante = tiempoLimiteMinutos * 60; // en segundos
    const tiempoSpan = document.getElementById('tiempo');
    
    function actualizarTemporizador() {
        const minutos = Math.floor(tiempoRestante / 60);
        const segundos = tiempoRestante % 60;
        
        // Formatear tiempo
        tiempoSpan.textContent = minutos + ':' + (segundos < 10 ? '0' : '') + segundos;
        
        // Cambiar color cuando quede poco tiempo
        const temporizadorDiv = document.getElementById('temporizador');
        if (tiempoRestante <= 60) {
            temporizadorDiv.classList.remove('alert-info');
            temporizadorDiv.classList.add('alert-danger');
            
            if (tiempoRestante === 60) {
                alert('‚è∞ ¬°Queda 1 minuto!');
            }
        } else if (tiempoRestante <= 300) {
            temporizadorDiv.classList.remove('alert-info');
            temporizadorDiv.classList.add('alert-warning');
        }
        
        tiempoRestante--;
        
        if (tiempoRestante < 0) {
            alert('‚è∞ Se acab√≥ el tiempo. El quiz se enviar√° autom√°ticamente.');
            document.getElementById('quizForm').submit();
        }
    }
    
    // Actualizar cada segundo
    setInterval(actualizarTemporizador, 1000);
</script>
{% endif %}
{% endblock %}